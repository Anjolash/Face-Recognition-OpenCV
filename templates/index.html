<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Recognition System - Session Isolated</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: white;
            margin-bottom: 10px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            text-align: center;
            color: rgba(255,255,255,0.9);
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .session-notice {
            text-align: center;
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.95em;
            border: 2px solid rgba(255,255,255,0.3);
        }

        .session-notice strong {
            color: #ffd700;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            animation: fadeIn 0.3s;
        }

        .modal.show {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 650px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            animation: slideIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-content h2 {
            color: #667eea;
            margin-bottom: 20px;
            text-align: center;
            font-size: 2em;
        }

        .modal-content h3 {
            color: #764ba2;
            margin-top: 20px;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .modal-content ul {
            margin-left: 20px;
            margin-bottom: 15px;
        }

        .modal-content li {
            margin-bottom: 8px;
            line-height: 1.6;
        }

        .warning-box {
            background: #fff3cd;
            border: 2px solid #ffc107;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-weight: bold;
            text-align: center;
        }

        .tip-box {
            background: #d1ecf1;
            border: 2px solid #0c5460;
            color: #0c5460;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .close-modal {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 40px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            display: block;
            margin: 25px auto 0;
            transition: all 0.3s;
        }

        .close-modal:hover {
            background: #764ba2;
            transform: translateY(-2px);
        }

        .help-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #667eea;
            color: white;
            border: none;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 999;
            transition: all 0.3s;
        }

        .help-btn:hover {
            background: #764ba2;
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }

        .capture-status {
            text-align: center;
            padding: 15px;
            margin: 15px auto;
            max-width: 400px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 1.1em;
            transition: all 0.3s;
        }

        .capture-status.waiting {
            background: #fee;
            color: #c00;
            border: 2px solid #f00;
        }

        .capture-status.detecting {
            background: #efe;
            color: #080;
            border: 2px solid #0f0;
        }

        .capture-status.complete {
            background: #eef;
            color: #008;
            border: 2px solid #00f;
        }

        .people-list {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .people-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .people-list h3 {
            color: #667eea;
        }

        .session-stats {
            font-size: 0.9em;
            color: #666;
            background: #f0f0f0;
            padding: 8px 12px;
            border-radius: 6px;
        }

        .session-stats .base {
            color: #10b981;
            font-weight: bold;
        }

        .session-stats .temp {
            color: #f59e0b;
            font-weight: bold;
        }

        .reset-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s;
        }

        .reset-btn:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }

        .person-tag {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            margin: 5px;
            font-size: 0.9em;
        }

        .person-tag.base {
            background: #10b981;
        }

        .person-tag.temporary {
            background: #f59e0b;
            position: relative;
        }

        .person-tag.temporary::after {
            content: "‚è±Ô∏è";
            margin-left: 5px;
        }

        .error-message {
            background: #fee;
            border: 2px solid #f00;
            padding: 15px;
            border-radius: 8px;
            color: #c00;
            margin: 20px 0;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            flex: 1;
            min-width: 150px;
            padding: 15px;
            background: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        .tab-content {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .tab-content.active {
            display: block;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .upload-area:hover {
            background: #f0f0f0;
            border-color: #764ba2;
        }

        .upload-area.drag-over {
            background: #e0e7ff;
            border-color: #667eea;
        }

        input[type="file"] {
            display: none;
        }

        .btn {
            background: #667eea;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .btn:hover {
            background: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .result-image {
            width: 100%;
            max-width: 800px;
            border-radius: 10px;
            margin: 20px auto;
            display: block;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .detection-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #667eea;
        }

        .detection-box.high-conf {
            border-left-color: #10b981;
        }

        .detection-box.medium-conf {
            border-left-color: #f59e0b;
        }

        .detection-box.low-conf {
            border-left-color: #ef4444;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
            font-size: 1.2em;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .canvas-container {
            position: relative;
            max-width: 640px;
            margin: 20px auto;
        }

        #webcam-canvas {
            width: 100%;
            border-radius: 10px;
            display: block;
        }

        .detection-overlay {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9em;
            max-width: calc(100% - 20px);
        }

        .screenshot-img {
            width: 100%;
            max-width: 300px;
            border-radius: 8px;
            margin-top: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        video {
            width: 100%;
            max-width: 400px;
            border-radius: 10px;
            display: block;
            margin: 0 auto;
        }

        #add-preview-img {
            max-width: 400px;
            border-radius: 10px;
            margin: 10px auto;
            display: block;
        }

        #person-name {
            width: 100%;
            max-width: 400px;
            padding: 12px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 1em;
            margin: 10px auto;
            display: block;
        }

        .manage-person {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }

        .manage-person.temporary {
            background: #fff9e6;
        }

        .person-status {
            font-size: 0.85em;
            color: #666;
            margin-left: 10px;
        }

        .person-status.temp {
            color: #f59e0b;
            font-weight: bold;
        }

        .person-status.base {
            color: #10b981;
        }

        .delete-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
        }

        .delete-btn:hover {
            background: #dc2626;
        }
    </style>
</head>
<body>
    <!-- Help Button -->
    <button class="help-btn" onclick="showInstructions()" title="Help & Instructions">‚ùì</button>

    <!-- Instructions Modal -->
    <div id="instructionsModal" class="modal">
        <div class="modal-content">
            <h2>üé≠ How to Use This System</h2>

            <h3>üìã Features</h3>
            <ul>
                <li><strong>üì∑ Image Upload:</strong> Upload a photo to identify faces instantly</li>
                <li><strong>üé• Video Upload:</strong> Upload video to track faces throughout</li>
                <li><strong>üìπ Live Webcam:</strong> Real-time recognition (works best locally)</li>
                <li><strong>‚ûï Add Person:</strong> Temporarily add new people to your session</li>
                <li><strong>üë• Manage:</strong> View and delete people in your session</li>
            </ul>

            <div class="warning-box">
                ‚ö†Ô∏è IMPORTANT: Your additions are TEMPORARY!<br>
                They disappear when you refresh or close the page.
            </div>

            <h3>üì∑ Image Upload</h3>
            <ul>
                <li>Drag & drop or click to upload (JPG, PNG)</li>
                <li>System detects all faces automatically</li>
                <li>Results color-coded by confidence:</li>
                <li style="margin-left: 30px;">üü¢ Green = 70%+ (high confidence)</li>
                <li style="margin-left: 30px;">üü° Yellow = 50-70% (medium)</li>
                <li style="margin-left: 30px;">üî¥ Red = &lt;50% (low)</li>
            </ul>

            <h3>üé• Video Upload</h3>
            <ul>
                <li>Upload any video file (MP4, AVI, MOV)</li>
                <li>Processes every 10th frame for speed</li>
                <li>Shows appearance count and confidence for each person</li>
                <li>Captures best screenshot of each detected person</li>
            </ul>

            <h3>‚ûï Smart Capture (Recommended)</h3>
            <ul>
                <li>Automatically captures 50 images when your face is detected</li>
                <li>Status indicators guide you:</li>
                <li style="margin-left: 30px;">üî¥ "Waiting for face..." = Position yourself in camera</li>
                <li style="margin-left: 30px;">üü¢ "Face detected - Capturing..." = Hold still!</li>
                <li style="margin-left: 30px;">üîµ "Capture complete!" = Done! Enter name</li>
            </ul>

            <div class="tip-box">
                üí° <strong>Tips for Best Results:</strong>
                <ul style="margin-top: 10px; margin-bottom: 0;">
                    <li>Face camera directly with good lighting</li>
                    <li>Turn your head slightly between captures for variety</li>
                    <li>Remove glasses/hats if possible</li>
                    <li>Stay in frame during entire capture process</li>
                </ul>
            </div>

            <h3>üîê Session Isolation</h3>
            <ul>
                <li>Base faces (from database) = <strong>Permanent</strong></li>
                <li>Your additions = <strong>Temporary (session only)</strong></li>
                <li>Each user gets their own isolated session</li>
                <li>Your changes won't affect other users</li>
                <li>Click "Reset Session" to restore base faces only</li>
            </ul>

            <div class="warning-box">
                üìù Remember: Closing tab = losing your additions!<br>
                For permanent additions, the base database must be updated.
            </div>

            <button class="close-modal" onclick="closeInstructions()">Got It! Let's Start üöÄ</button>
        </div>
    </div>

    <div class="container">
        <h1>üé≠ Face Recognition System</h1>
        <p class="subtitle">ArcFace-powered recognition with session isolation</p>
        <div class="session-notice">
            üîê <strong>Session-Isolated:</strong> Base faces are permanent. Your additions/deletions are temporary and won't affect others!
        </div>

        <!-- People List -->
        <div class="people-list">
            <div class="people-list-header">
                <h3>üìã Faces in Your Session</h3>
                <div class="session-stats" id="session-stats">
                    <span class="base">Loading...</span>
                </div>
                <button class="reset-btn" onclick="resetSession()">üîÑ Reset Session</button>
            </div>
            <div id="people-tags">Loading...</div>
            <div id="api-error" style="display: none;" class="error-message"></div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="showTab(event, 'image')">üì∑ Image Upload</button>
            <button class="tab" onclick="showTab(event, 'video')">üé• Video Upload</button>
            <button class="tab" onclick="showTab(event, 'webcam')">üìπ Live Webcam</button>
            <button class="tab" onclick="showTab(event, 'add')">‚ûï Add New Person</button>
            <button class="tab" onclick="showTab(event, 'manage')">üë• Manage People</button>
        </div>

        <!-- Image Upload Tab -->
        <div id="image-tab" class="tab-content active">
            <div class="upload-area" id="image-drop" onclick="document.getElementById('image-input').click()">
                <h3>üìÅ Click or Drag & Drop Image</h3>
                <p>Supports: JPG, PNG</p>
                <input type="file" id="image-input" accept="image/*" onchange="uploadImage(this.files[0])">
            </div>
            <div id="image-result"></div>
        </div>

        <!-- Video Upload Tab -->
        <div id="video-tab" class="tab-content">
            <div class="upload-area" id="video-drop" onclick="document.getElementById('video-input').click()">
                <h3>üé¨ Click or Drag & Drop Video</h3>
                <p>Supports: MP4, AVI, MOV</p>
                <input type="file" id="video-input" accept="video/*" onchange="uploadVideo(this.files[0])">
            </div>
            <div id="video-result"></div>
        </div>

        <!-- Webcam Tab -->
        <div id="webcam-tab" class="tab-content">
            <div style="text-align: center;">
                <button class="btn" id="start-webcam" onclick="startWebcam()">Start Webcam</button>
                <button class="btn" id="stop-webcam" onclick="stopWebcam()" style="display: none;">Stop Webcam</button>
            </div>
            <div class="canvas-container" id="webcam-container" style="display: none;">
                <video id="webcam" autoplay style="display: none; max-width: 640px;"></video>
                <canvas id="webcam-canvas"></canvas>
                <div class="detection-overlay" id="webcam-detections">Starting...</div>
            </div>
        </div>

        <!-- Add Person Tab -->
        <div id="add-tab" class="tab-content">
            <h3>Add New Person (Temporary - Session Only)</h3>
            <p style="margin-bottom: 20px; color: #f59e0b; font-weight: bold;">‚è±Ô∏è Added people are temporary and will disappear on page refresh!</p>

            <div style="display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 300px;">
                    <h4>Option 1: Auto-Capture (Recommended)</h4>
                    <p style="font-size: 0.9em; color: #666; margin-bottom: 10px;">
                        Automatically captures 50 images when face is detected
                    </p>
                    <div style="text-align: center;">
                        <button class="btn" id="start-add-webcam" onclick="startAddWebcam()">Start Smart Capture</button>
                        <button class="btn" id="stop-add-webcam" onclick="stopAddWebcam()" style="display: none;">Cancel</button>
                    </div>
                    <div id="add-webcam-container" style="display: none; margin-top: 20px;">
                        <video id="add-webcam" autoplay></video>

                        <div id="capture-status" class="capture-status waiting">
                            üë§ Position your face in camera...
                        </div>

                        <div style="text-align: center; margin-top: 10px;">
                            <p id="capture-progress" style="font-weight: bold; color: #667eea;">
                                Ready to capture: 0/50
                            </p>
                        </div>
                    </div>
                </div>

                <div style="flex: 1; min-width: 300px;">
                    <h4>Option 2: Upload Single Photo</h4>
                    <p style="font-size: 0.9em; color: #666; margin-bottom: 10px;">
                        Upload one image (less accurate than auto-capture)
                    </p>
                    <div class="upload-area" onclick="document.getElementById('add-person-input').click()" style="padding: 20px;">
                        <p>Click to upload image</p>
                        <input type="file" id="add-person-input" accept="image/*" onchange="loadAddImage(this.files[0])">
                    </div>
                </div>
            </div>

            <div id="add-preview" style="display: none; text-align: center;">
                <h4>Preview</h4>
                <img id="add-preview-img">
                <input type="text" id="person-name" placeholder="Enter person's name">
                <button class="btn" onclick="addPerson()" style="display: block; margin: 10px auto;">‚ûï Add to Session</button>
                <div id="add-result"></div>
            </div>
        </div>

        <!-- Manage People Tab -->
        <div id="manage-tab" class="tab-content">
            <h3>Manage People in Your Session</h3>
            <p style="margin-bottom: 15px; color: #666; font-size: 0.9em;">
                üü¢ Base people (permanent) | üü° Your additions (temporary)
            </p>
            <div id="people-manage">Loading...</div>
        </div>
    </div>

    <script>
        let webcamStream = null;
        let webcamInterval = null;
        let addWebcamStream = null;
        let capturedImage = null;
        let captureInterval = null;
        let capturedImages = [];
        const TARGET_IMAGES = 50;
        let basePeople = [];

        // Show instructions on first visit
        window.addEventListener('load', function() {
            if (!localStorage.getItem('instructionsSeen')) {
                setTimeout(showInstructions, 800);
                localStorage.setItem('instructionsSeen', 'true');
            }
        });

        function showInstructions() {
            document.getElementById('instructionsModal').classList.add('show');
        }

        function closeInstructions() {
            document.getElementById('instructionsModal').classList.remove('show');
        }

        // Close when clicking outside modal
        window.onclick = function(event) {
            const modal = document.getElementById('instructionsModal');
            if (event.target === modal) {
                closeInstructions();
            }
        }

        // Reset session
        async function resetSession() {
            if (!confirm('‚ö†Ô∏è This will reset your session back to base faces. Your additions will be removed. Continue?')) {
                return;
            }

            try {
                const response = await fetch('/api/reset', {
                    method: 'POST',
                    credentials: 'include'
                });

                const data = await response.json();

                if (data.success) {
                    alert(data.message);
                    loadPeople();
                } else {
                    alert('Error resetting session');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Load people list
        async function loadPeople() {
            console.log('üîÑ Loading people from API...');

            try {
                const response = await fetch('/api/people', {
                    credentials: 'include'
                });
                console.log('üì° Response status:', response.status);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('‚úÖ Data received:', data);

                const statsDiv = document.getElementById('session-stats');
                statsDiv.innerHTML = `
                    <span class="base">Base: ${data.base_count}</span> ‚Ä¢
                    <span class="temp">Your Additions: ${data.session_added}</span> ‚Ä¢
                    <span>Total: ${data.people.length}</span>
                `;

                basePeople = data.people.slice(0, data.base_count);

                const tagsContainer = document.getElementById('people-tags');
                if (data.people.length === 0) {
                    tagsContainer.innerHTML = '<p style="color: #999;">No people in session yet.</p>';
                } else {
                    tagsContainer.innerHTML = data.people.map(person => {
                        const isBase = basePeople.includes(person);
                        const className = isBase ? 'person-tag base' : 'person-tag temporary';
                        const title = isBase ? 'Permanent base person' : 'Temporary addition (this session only)';
                        const displayName = person.replace('pins_', '');
                        return `<span class="${className}" title="${title}">${displayName}</span>`;
                    }).join('');
                }

                document.getElementById('api-error').style.display = 'none';
                updateManageSection(data.people);

            } catch (error) {
                console.error('‚ùå Error loading people:', error);

                const errorDiv = document.getElementById('api-error');
                errorDiv.style.display = 'block';
                errorDiv.innerHTML = `
                    <strong>‚ö†Ô∏è Cannot connect to server</strong><br>
                    Error: ${error.message}<br>
                    <small>Make sure the server is running</small>
                `;

                document.getElementById('session-stats').innerHTML = '<span style="color: red;">Error</span>';
                document.getElementById('people-tags').innerHTML =
                    '<p style="color: red;">Failed to load. Check console (F12) for details.</p>';
                document.getElementById('people-manage').innerHTML =
                    '<p style="color: red;">Server not reachable</p>';
            }
        }

        function updateManageSection(people) {
            const manageContainer = document.getElementById('people-manage');

            if (people.length === 0) {
                manageContainer.innerHTML = '<p>No people in session yet.</p>';
            } else {
                manageContainer.innerHTML = people.map(person => {
                    const isBase = basePeople.includes(person);
                    const statusClass = isBase ? 'base' : 'temp';
                    const statusText = isBase ? '(Permanent - refreshable)' : '(Temporary)';
                    const rowClass = isBase ? '' : 'temporary';
                    const displayName = person.replace('pins_', '');
                    return `
                        <div class="manage-person ${rowClass}">
                            <span>
                                <strong>${displayName}</strong>
                                <span class="person-status ${statusClass}">${statusText}</span>
                            </span>
                            <button class="delete-btn" onclick="deletePerson('${person}')">Delete</button>
                        </div>
                    `;
                }).join('');
            }
        }

        function showTab(event, tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        async function startAddWebcam() {
            try {
                addWebcamStream = await navigator.mediaDevices.getUserMedia({ video: true });
                const video = document.getElementById('add-webcam');
                video.srcObject = addWebcamStream;

                document.getElementById('start-add-webcam').style.display = 'none';
                document.getElementById('stop-add-webcam').style.display = 'inline-block';
                document.getElementById('add-webcam-container').style.display = 'block';

                setTimeout(startAutoCapture, 1000);
            } catch (error) {
                alert('Could not access webcam: ' + error.message);
            }
        }

        function stopAddWebcam() {
            if (captureInterval) {
                clearInterval(captureInterval);
                captureInterval = null;
            }

            if (addWebcamStream) {
                addWebcamStream.getTracks().forEach(track => track.stop());
                document.getElementById('start-add-webcam').style.display = 'inline-block';
                document.getElementById('stop-add-webcam').style.display = 'none';
                document.getElementById('add-webcam-container').style.display = 'none';
            }

            capturedImages = [];
            updateCaptureProgress(0, false);
        }

        async function startAutoCapture() {
            capturedImages = [];
            updateCaptureProgress(0, false);

            captureInterval = setInterval(async () => {
                const video = document.getElementById('add-webcam');
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0);

                const imageData = canvas.toDataURL('image/jpeg', 0.8);

                try {
                    const response = await fetch('/api/detect_face', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ image: imageData })
                    });

                    const data = await response.json();

                    if (data.face_detected) {
                        capturedImages.push(imageData);
                        updateCaptureProgress(capturedImages.length, true);

                        if (capturedImages.length >= TARGET_IMAGES) {
                            clearInterval(captureInterval);
                            captureInterval = null;

                            capturedImage = capturedImages[Math.floor(TARGET_IMAGES / 2)];
                            document.getElementById('add-preview-img').src = capturedImage;
                            document.getElementById('add-preview').style.display = 'block';

                            stopAddWebcam();

                            alert(`‚úì Captured ${TARGET_IMAGES} images! Enter the person's name and click Add.`);
                        }
                    } else {
                        updateCaptureProgress(capturedImages.length, false);
                    }
                } catch (error) {
                    console.error('Error detecting face:', error);
                }
            }, 200);
        }

        function updateCaptureProgress(count, faceDetected) {
            const progressText = document.getElementById('capture-progress');
            const statusDiv = document.getElementById('capture-status');

            if (progressText) {
                progressText.textContent = `Captured: ${count}/${TARGET_IMAGES}`;

                if (count >= TARGET_IMAGES) {
                    progressText.textContent = `‚úì Captured ${TARGET_IMAGES} images!`;
                    progressText.style.color = '#10b981';
                }
            }

            if (statusDiv) {
                if (count >= TARGET_IMAGES) {
                    statusDiv.className = 'capture-status complete';
                    statusDiv.innerHTML = '‚úì Capture complete!';
                } else if (faceDetected) {
                    statusDiv.className = 'capture-status detecting';
                    statusDiv.innerHTML = '‚úì Face detected - Capturing...';
                } else {
                    statusDiv.className = 'capture-status waiting';
                    statusDiv.innerHTML = 'üë§ Waiting for face...';
                }
            }
        }

        function loadAddImage(file) {
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                capturedImage = e.target.result;
                capturedImages = [];
                document.getElementById('add-preview-img').src = capturedImage;
                document.getElementById('add-preview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        async function addPerson() {
            const name = document.getElementById('person-name').value.trim();
            const resultDiv = document.getElementById('add-result');

            if (!name) {
                resultDiv.innerHTML = '<p style="color: red;">Please enter a name</p>';
                return;
            }

            const hasMultipleImages = capturedImages.length > 0;

            if (!hasMultipleImages && !capturedImage) {
                resultDiv.innerHTML = '<p style="color: red;">Please capture images or upload an image</p>';
                return;
            }

            resultDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Adding person to your session...</p></div>';

            try {
                const payload = { name: name };

                if (hasMultipleImages) {
                    payload.images = capturedImages;
                } else {
                    payload.image = capturedImage;
                }

                const response = await fetch('/api/add_person', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (data.success) {
                    resultDiv.innerHTML = `<p style="color: green;">‚úì ${data.message}<br><small style="color: #f59e0b;">‚è±Ô∏è This person is temporary and will disappear on page refresh</small></p>`;
                    document.getElementById('person-name').value = '';
                    document.getElementById('add-preview').style.display = 'none';
                    capturedImage = null;
                    capturedImages = [];
                    loadPeople();
                } else {
                    resultDiv.innerHTML = `<p style="color: red;">‚úó ${data.error}</p>`;
                }
            } catch (error) {
                console.error('Error adding person:', error);
                resultDiv.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
        }

        async function deletePerson(name) {
            const isBase = basePeople.includes(name);
            const msg = isBase
                ? `Delete ${name}?\n\nNote: This is a base person. They will reappear when you refresh the page.`
                : `Delete ${name}?\n\nThis person will be removed from your session.`;

            if (!confirm(msg)) {
                return;
            }

            try {
                const response = await fetch('/api/delete_person', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ name: name })
                });

                const data = await response.json();

                if (data.success) {
                    alert(data.message);
                    loadPeople();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error deleting person: ' + error.message);
            }
        }

        async function uploadImage(file) {
            if (!file) return;

            const resultDiv = document.getElementById('image-result');
            resultDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Processing image...</p></div>';

            const formData = new FormData();
            formData.append('image', file);

            try {
                const response = await fetch('/api/recognize_image', {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });

                const data = await response.json();

                let html = `<img src="${data.annotated_image}" class="result-image">`;
                html += '<h3>Detections:</h3>';

                if (data.detections.length === 0) {
                    html += '<p>No faces detected</p>';
                } else {
                    data.detections.forEach(det => {
                        const confClass = det.confidence >= 0.7 ? 'high-conf' :
                                        det.confidence >= 0.5 ? 'medium-conf' : 'low-conf';
                        const displayName = det.name.replace('pins_', '');
                        html += `
                            <div class="detection-box ${confClass}">
                                <strong>${displayName}</strong> - ${(det.confidence * 100).toFixed(1)}% confidence
                            </div>
                        `;
                    });
                }

                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = '<p style="color: red;">Error processing image</p>';
            }
        }

        async function uploadVideo(file) {
            if (!file) return;

            const resultDiv = document.getElementById('video-result');
            resultDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Processing video... This may take a while</p></div>';

            const formData = new FormData();
            formData.append('video', file);

            try {
                const response = await fetch('/api/recognize_video', {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });

                const data = await response.json();

                let html = `<h3>Video Summary</h3>`;
                html += `<p>Processed ${data.processed_frames} frames out of ${data.total_frames} total</p>`;

                if (data.detections.length === 0) {
                    html += '<p>No known faces detected in video</p>';
                } else {
                    html += '<h4>Identified People:</h4>';
                    data.detections.forEach(det => {
                        const confClass = det.confidence >= 0.7 ? 'high-conf' :
                                        det.confidence >= 0.5 ? 'medium-conf' : 'low-conf';
                        const displayName = det.name.replace('pins_', '');
                        html += `
                            <div class="detection-box ${confClass}">
                                <strong>${displayName}</strong> - Appeared ${det.appearances} times (${(det.confidence * 100).toFixed(1)}% max confidence)
                                ${det.screenshot ? `<br><img src="${det.screenshot}" class="screenshot-img" alt="${displayName}">` : ''}
                            </div>
                        `;
                    });
                }

                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = '<p style="color: red;">Error processing video</p>';
            }
        }

        async function startWebcam() {
            try {
                webcamStream = await navigator.mediaDevices.getUserMedia({ video: true });
                const video = document.getElementById('webcam');
                video.srcObject = webcamStream;

                document.getElementById('start-webcam').style.display = 'none';
                document.getElementById('stop-webcam').style.display = 'inline-block';
                document.getElementById('webcam-container').style.display = 'block';

                webcamInterval = setInterval(processWebcamFrame, 500);
            } catch (error) {
                alert('Could not access webcam');
            }
        }

        function stopWebcam() {
            if (webcamStream) {
                webcamStream.getTracks().forEach(track => track.stop());
                clearInterval(webcamInterval);

                document.getElementById('start-webcam').style.display = 'inline-block';
                document.getElementById('stop-webcam').style.display = 'none';
                document.getElementById('webcam-container').style.display = 'none';
            }
        }

        async function processWebcamFrame() {
            const video = document.getElementById('webcam');
            const canvas = document.getElementById('webcam-canvas');
            const ctx = canvas.getContext('2d');

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            const imageData = canvas.toDataURL('image/jpeg');

            try {
                const response = await fetch('/api/webcam_frame', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ image: imageData })
                });

                const data = await response.json();
                const detDiv = document.getElementById('webcam-detections');

                if (data.detections.length === 0) {
                    detDiv.innerHTML = 'üë§ No faces detected';
                } else {
                    data.detections.forEach(det => {
                        const [x1, y1, x2, y2] = det.bbox;

                        let color;
                        if (det.confidence >= 0.7) {
                            color = '#10b981';
                        } else if (det.confidence >= 0.5) {
                            color = '#f59e0b';
                        } else {
                            color = '#ef4444';
                        }

                        ctx.strokeStyle = color;
                        ctx.lineWidth = 3;
                        ctx.strokeRect(x1, y1, x2 - x1, y2 - y1);

                        const displayName = det.name.replace('pins_', '');
                        const label = `${displayName} (${(det.confidence * 100).toFixed(1)}%)`;
                        ctx.font = '16px Arial';
                        const textMetrics = ctx.measureText(label);
                        const textHeight = 20;

                        ctx.fillStyle = color;
                        ctx.fillRect(x1, y1 - textHeight - 5, textMetrics.width + 10, textHeight + 5);

                        ctx.fillStyle = 'white';
                        ctx.fillText(label, x1 + 5, y1 - 8);
                    });

                    detDiv.innerHTML = data.detections
                        .filter(det => det.name !== 'Unknown')
                        .map(det => {
                            const displayName = det.name.replace('pins_', '');
                            return `‚úì ${displayName}: ${(det.confidence * 100).toFixed(1)}%`;
                        })
                        .join('<br>') || '‚ùì Unknown faces';
                }
            } catch (error) {
                console.error('Error processing frame:', error);
            }
        }

        ['image-drop', 'video-drop'].forEach(id => {
            const elem = document.getElementById(id);

            elem.addEventListener('dragover', (e) => {
                e.preventDefault();
                elem.classList.add('drag-over');
            });

            elem.addEventListener('dragleave', () => {
                elem.classList.remove('drag-over');
            });

            elem.addEventListener('drop', (e) => {
                e.preventDefault();
                elem.classList.remove('drag-over');

                const file = e.dataTransfer.files[0];
                if (id === 'image-drop') uploadImage(file);
                else uploadVideo(file);
            });
        });

        console.log('üöÄ Page loaded, loading session data...');
        loadPeople();
    </script>
</body>
</html>